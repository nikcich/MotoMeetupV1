<!DOCTYPE html>
<html>
  <head>
    <title>Meetup Map</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src = "https://smtpjs.com/v3/smtp.js"></script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkQaHkO5f2LymmHzYD0bAcAxj6h9a2kMU&callback=initMap&libraries=places&v=weekly" defer ></script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@2.3.2/dist/email.min.js"></script>
      <script type="text/javascript">
        (function(){
            emailjs.init("user_mtIxxJUUhp65VCg4m27S0");
        })();
      </script>

    <script>
      "use strict";

      let map;

      let nikolas = {name: "Nikolas#9362", lat: 33.1031744, long:-96.67055030000002};
      let yammie = {name: "yammienoob#7923", lat: 30.267153,long: -97.7430608};
      let spite = {name: "Spite#2151", lat: 30.267153,long: -97.7430608};

      console.log(nikolas.name);
      let PeopleList = [nikolas, yammie, spite];

      let markers = [];
      let windows = [];

      let checked = [];

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: {
            lat: 36.670205,
            lng: -97.295511
          },
          zoom: 4
        });

        for(let i =0; i < PeopleList.length; i++){
          if(checked.length > 0){
            let mybool = false;
            for(let j = 0; j < checked.length; j++){
              if(PeopleList[i].lat === checked[j].lat && PeopleList[i].long === checked[j].long){
                mybool = true;
                checked[j].name = checked[j].name + ", " + PeopleList[i].name;
                break;
              }
            }
            if(!mybool){
              checked.push({name: PeopleList[i].name, lat: PeopleList[i].lat, long: PeopleList[i].long});
            }
          }else{
            checked.push({name: PeopleList[i].name, lat: PeopleList[i].lat, long: PeopleList[i].long});
          }
        }

        for(let i =0; i < checked.length; i++){
          var myLatlng = new google.maps.LatLng(checked[i].lat, checked[i].long);
          var marker = new google.maps.Marker({
            position: myLatlng,
            title: checked[i].name
            })

          var infoWindow = new google.maps.InfoWindow({
            content:'<h3>'+ checked[i].name+'</h3>'
          })

          windows.push(infoWindow);

          markers.push(marker);
        }

        

        for(let i = 0; i < markers.length; i++){
          markers[i].setMap(map);
          markers[i].addListener('click', function(){
            windows[i].open(map, markers[i]);
          });
        }
        
      }
    </script>
      
    <script>
      var searchInput = 'search_input';

      $(document).ready(function () {
          var autocomplete;
          autocomplete = new google.maps.places.Autocomplete((document.getElementById(searchInput)), {
              types: ['geocode'],
          });
        
          google.maps.event.addListener(autocomplete, 'place_changed', function () {
              var near_place = autocomplete.getPlace();
              document.getElementById('loc_lat').value = near_place.geometry.location.lat();
              document.getElementById('loc_long').value = near_place.geometry.location.lng();
          
              document.getElementById('latitude_view').innerHTML = near_place.geometry.location.lat();
              document.getElementById('longitude_view').innerHTML = near_place.geometry.location.lng();
          });
      });

      $(document).on('change', '#'+searchInput, function () {
          
        
          document.getElementById('latitude_view').innerHTML = '0';
          document.getElementById('longitude_view').innerHTML = '0';
      });

    </script>

<header>
  <nav>
    <ul>
      <h3>Motorcycle Meetups Member List</h3>
    </ul>
  </nav>
</header>

  </head>

  

  <body>
    <div id="map"></div>

    <div id="root"></div>


    <!-- Autocomplete location search input --> 
    <div class="form-group">
      <label>Location:</label>
      <input type="text" class="form-control" id="search_input" placeholder="Type general location..." />
      <input type="hidden" id="loc_lat" />
      <input type="hidden" id="loc_long" />
    </div>

    <!-- Display latitude and longitude -->
    <div class="latlong-view">
      <p><b>Latitude:</b> <span id="latitude_view"></span></p>
      <p><b>Longitude:</b> <span id="longitude_view"></span></p>
    </div>


    <div id = "submitPart">
      <input type="text" class="DiscordName" id = "DiscordName" placeholder="Type Discord name with ID (Name#ID)" />
      <input type="button" class="AddToList" value="Click to Add To List" onclick="sendEmail()"/>
    </div>

    <script src="https://smtpjs.com/v3/smtp.js"></script>
    <script type="text/javascript">
      function sendEmail() {
        
        var inputVal = document.getElementById("DiscordName").value;

        var latVal = document.getElementById("latitude_view").innerHTML;

        var LongVal = document.getElementById("longitude_view").innerHTML;
        
        if((latVal === '0' && LongVal === '0') || (latVal === '' && LongVal === '')){
          alert("Please enter a location first");
        }else if(inputVal === ''){
          alert("Please enter a username first");
        }else{
          var data = {
            service_id: 'gmail',
            template_id: 'bigdicks',
            user_id: 'user_mtIxxJUUhp65VCg4m27S0',
            template_params: {
              'username': inputVal,
              'latv': latVal,
              'longv': LongVal
            }
          };
        
          $.ajax('https://api.emailjs.com/api/v1.0/email/send', {
              type: 'POST',
              data: JSON.stringify(data),
              contentType: 'application/json'
          }).done(function() {
              alert('Your request will be verified before adding');
          }).fail(function(error) {
              alert('Oops... ' + JSON.stringify(error));
          });
        }
      }
    </script>
    
    <div id = "FindPeople">
      <p><b>--FIND MEMBERS NEAR ME--</b> <span id="myLabel1"></span></p>
      <input type="text" class="Radius" id = "Radius" placeholder="Enter radius in miles" />
      <input type="button" class="FindPpl" value="Click to Find People" onclick="findPeople()"/>
      <p><b id = "resultLabel">Members will appear here:</b> <span id="myLabel2"></span></p>
      <p><b id = "results">No members to display</b> <span id="myLabel2"></span></p>
    </div>

    <div id = "everyone">
      <h1>Member Meetup Resource Created and Operated by Nik</h1>
    </div>

    <script type="text/javascript">

      function toRadians(n){
        var pi = Math.PI;
        return n * (pi/180);
      }

      function getDist(lat1, lat2, lon1, lon2){
        var lon1 = toRadians(lon1); 
        var lon2 = toRadians(lon2); 
        var lat1 = toRadians(lat1); 
        var lat2 = toRadians(lat2); 

        var dlon = lon2 - lon1;  
        var dlat = lat2 - lat1; 
        var a = Math.pow(Math.sin(dlat / 2), 2) 
                 + Math.cos(lat1) * Math.cos(lat2) 
                 * Math.pow(Math.sin(dlon / 2),2); 
              
        var c = 2 * Math.asin(Math.sqrt(a)); 

        var r = 3956;

        return(c*r);
      }

      function findPeople(){
        
        var radius = document.getElementById("Radius").value;
        var latVal = document.getElementById("latitude_view").innerHTML;
        var LongVal = document.getElementById("longitude_view").innerHTML;
        var resultLabel = document.getElementById("results");
        
        var found = "";

        if((latVal === '0' && LongVal === '0') || (latVal === '' && LongVal === '')){
          alert("Please select a location first");
        }else{

          for(let i = 0; i < PeopleList.length; i ++){
            var dist = getDist(PeopleList[i].lat, latVal, PeopleList[i].long, LongVal);
            if(dist <= radius){
              if(found === ""){
                found = "@"+PeopleList[i].name;
              }else{
                found = found + "  @" + PeopleList[i].name;
              }
              
            }
          }
          
          if(found === ""){
            found = "No members near you :(";
          }

          resultLabel.innerText = found;
        }
      }

    </script>


  </body>
</html>